@model IEnumerable<SuperRH.Models.Colaborador>

@{
    ViewData["Title"] = "Gestão de Histórico";
}

<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item small text-uppercase">
            <a href="/" class="text-secondary text-decoration-none">Dashboard</a>
        </li>
        <li class="breadcrumb-item small text-uppercase active text-primary">
            Linha do Tempo
        </li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-end mb-4">
    <div>
        <h3 class="fw-bold mb-0 text-white text-uppercase tracking-tight">
            Histórico Profissional
        </h3>
        <p class="text-secondary mb-0 small">
            Selecione um colaborador para registrar novos eventos ou consultar a timeline.
        </p>
    </div>
</div>

<div class="card bg-dark border-secondary border-opacity-10 rounded-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0 custom-table">
                <thead>
                    <tr class="text-secondary text-uppercase small border-bottom border-secondary border-opacity-25">
                        <th class="ps-4 py-3 fw-bold">Colaborador</th>
                        <th class="py-3 fw-bold">CPF</th>
                        <th class="py-3 fw-bold">Cargo</th>
                        <th class="text-end pe-4 py-3 fw-bold">Histórico</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="border-bottom border-secondary border-opacity-10">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-square me-3 bg-primary bg-opacity-10 border border-primary border-opacity-25
                                                d-flex align-items-center justify-content-center text-primary fw-bold">
                                        @item.NomeCompleto.Substring(0, 1).ToUpper()
                                    </div>
                                    <div class="fw-bold text-white">@item.NomeCompleto</div>
                                </div>
                            </td>

                            <td class="text-secondary font-monospace small">@item.CPF</td>

                            <td class="text-secondary small">
                                <i class="bi bi-diagram-3 me-1"></i> @item.Cargo
                            </td>

                            <td class="text-end pe-4">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-primary rounded-0 fw-bold text-uppercase"
                                            style="font-size:0.65rem"
                                            onclick="abrirAdicionar(@item.idColaborador, '@item.NomeCompleto')">
                                        <i class="bi bi-plus-circle me-1"></i> Add
                                    </button>

                                    <button class="btn btn-outline-secondary rounded-0 fw-bold text-uppercase ms-1"
                                            style="font-size:0.65rem"
                                            onclick="abrirHistorico(@item.idColaborador, '@item.NomeCompleto')">
                                        <i class="bi bi-journal-text me-1"></i> Ver
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL ADD -->
<div class="modal fade" id="modalAddHistorico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-secondary border-opacity-25 rounded-0 shadow-lg">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold small text-uppercase" id="tituloAddHist"></h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="conteudoAddHist"></div>
        </div>
    </div>
</div>

<!-- MODAL TIMELINE -->
<div class="modal fade" id="modalVerHistorico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark border-secondary border-opacity-25 rounded-0 shadow-lg">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold small text-uppercase" id="tituloVerHist"></h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="conteudoVerHist"></div>
        </div>
    </div>
</div>

<!-- MODAL DETALHES (MESMO PADRÃO) -->
<div class="modal fade" id="modalDetalheHistorico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-secondary border-opacity-25 rounded-0 shadow-lg">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold small text-uppercase">
                    Detalhes da Ocorrência
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="conteudoDetalheHistorico"></div>
        </div>
    </div>
</div>

<!-- MODAL SUCESSO -->
<div class="modal fade" id="modalSucessoHistorico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-success border-opacity-50 rounded-0 shadow-lg">
            <div class="modal-header border-bottom border-success border-opacity-25">
                <h5 class="modal-title text-success fw-bold small text-uppercase">
                    Sucesso
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center py-5">
                <i class="bi bi-check-circle fs-1 text-success mb-3"></i>
                <p class="text-white fw-bold mb-1">
                    Histórico gravado com sucesso!
                </p>
                <p class="text-secondary small mb-0">
                    O evento foi registrado corretamente na timeline.
                </p>
            </div>

            <div class="modal-footer border-top border-success border-opacity-10">
                <button class="btn btn-success rounded-0 fw-bold text-uppercase btn-sm"
                        data-bs-dismiss="modal">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        const modalAdd = new bootstrap.Modal(document.getElementById('modalAddHistorico'));
        const modalVer = new bootstrap.Modal(document.getElementById('modalVerHistorico'));
        const modalDetalhe = new bootstrap.Modal(document.getElementById('modalDetalheHistorico'));
        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucessoHistorico'));

        function abrirAdicionar(id, nome) {
            $("#tituloAddHist").text("REGISTRAR EVENTO — " + nome.toUpperCase());
            $("#conteudoAddHist").html(spinner())
                .load("/Historico/Create?idColaborador=" + id);
            modalAdd.show();
        }

        function abrirHistorico(id, nome) {
            $("#tituloVerHist").text("HISTÓRICO COMPLETO — " + nome.toUpperCase());
            $("#conteudoVerHist").html(spinner())
                .load("/Historico/Timeline?idColaborador=" + id);
            modalVer.show();
        }

        function verDetalhesHistorico(id) {
            $("#conteudoDetalheHistorico").html(spinner())
                .load("/Historico/Detalhes/" + id);
            modalDetalhe.show();
        }

        function spinner() {
            return `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>`;
        }

        // SUBMIT DO CREATE (delegado – FUNCIONA COM AJAX)
        $(document).on("submit", "#formHistorico", function (e) {
            e.preventDefault();

            const form = $(this);

            $.ajax({
                url: form.attr("action"),
                type: "POST",
                data: form.serialize(),
                success: function (res) {
                    if (res.sucesso) {
                        modalAdd.hide();
                        modalSucesso.show();
                    }
                },
                error: function () {
                    alert("Erro ao salvar histórico.");
                }
            });
        });
    </script>

}
